<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>주문 API 테스트</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1, h2 { color: #333; }
        section { margin-bottom: 40px; }
        label { display: inline-block; width: 80px; }
        input[type=number] { width: 150px; padding: 5px; margin-right: 10px; }
        button { padding: 6px 12px; cursor: pointer; }
        table { border-collapse: collapse; margin-top: 10px; width: 100%; max-width: 700px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #f8f8f8; }
        .error { color: #c00; font-weight: bold; margin-top: 10px; }
        .success { color: #080; font-weight: bold; margin-top: 10px; }
        .item-row { margin-bottom: 5px; }
    </style>
</head>
<body>
<h1>🛒 주문 API 테스트 화면</h1>

<!-- 주문 생성 -->
<section>
    <h2>1. 주문 생성 (여러 상품)</h2>
    <form id="createOrderForm">
        <div id="itemList">
            <div class="item-row">
                <label>상품 ID:</label>
                <input type="number" name="itemId" required />
                <label>수량:</label>
                <input type="number" name="quantity" value="1" min="1" required />
                <button type="button" onclick="removeItemRow(this)">❌</button>
            </div>
        </div>
        <button type="button" onclick="addItemRow()">➕ 상품 추가</button><br /><br />
        <button type="submit">주문 생성</button>
    </form>
    <div id="createOrderResult"></div>
</section>

<!-- 주문 상품 취소 -->
<section>
    <h2>2. 주문 상품 취소</h2>
    <form id="cancelOrderForm">
        <label>주문 ID:</label>
        <input type="number" name="orderId" required />
        <label>상품 ID:</label>
        <input type="number" name="itemId" required />
        <button type="submit">상품 취소</button>
    </form>
    <div id="cancelOrderResult"></div>
</section>

<!-- 주문 조회 -->
<section>
    <h2>3. 주문 조회</h2>
    <form id="getOrderForm">
        <label>주문 ID:</label>
        <input type="number" name="orderId" required />
        <button type="submit">주문 조회</button>
    </form>
    <div id="getOrderResult"></div>
</section>

<script>
    function addItemRow() {
        const itemList = document.getElementById('itemList');
        const row = document.createElement('div');
        row.className = 'item-row';
        row.innerHTML = `
            <label>상품 ID:</label>
            <input type="number" name="itemId" required />
            <label>수량:</label>
            <input type="number" name="quantity" value="1" min="1" required />
            <button type="button" onclick="removeItemRow(this)">❌</button>
        `;
        itemList.appendChild(row);
    }

    function removeItemRow(button) {
        button.parentNode.remove();
    }

    // 주문 생성 결과 렌더링 (CreateOrderResponse DTO 기반)
    function renderCreateOrderResult(data, error) {
        const container = document.getElementById('createOrderResult');
        container.innerHTML = '';

        if (error) {
            container.innerHTML = `<p class="error">❌ ${error}</p>`;
            return;
        }

        // 성공 시 orderId, totalPrice, orderItemList 출력
        let html = `<p class="success">✅ 주문이 생성되었습니다. 주문번호: <strong>${data.orderId}</strong></p>`;
        html += `<p>총 주문 금액: <strong>${data.totalPrice.toLocaleString()}원</strong></p>`;

        if (data.orderItemList && data.orderItemList.length > 0) {
            html += `<table>
                <thead>
                    <tr>
                        <th>상품 ID</th>
                        <th>상품명</th>
                        <th>수량</th>
                        <th>실구매금액</th>
                    </tr>
                </thead>
                <tbody>`;
            data.orderItemList.forEach(item => {
                const total = item.purchasePrice * item.quantity;
                html += `<tr>
                    <td>${item.itemId}</td>
                    <td>${item.name || '-'}</td>
                    <td>${item.quantity}</td>
                    <td>${item.purchasePrice.toLocaleString()}원</td>
                </tr>`;
            });
            html += `</tbody></table>`;
        }
        container.innerHTML = html;
    }

    // 주문 상품 취소 결과 렌더링 (CancelOrderItemResponse DTO 기반)
    function renderCancelOrderResult(data, error) {
        const container = document.getElementById('cancelOrderResult');
        container.innerHTML = '';

        if (error) {
            container.innerHTML = `<p class="error">❌ ${error}</p>`;
            return;
        }

        let html = `<p class="success">✅ 상품이 취소되었습니다.</p>`;
        html += `<table>
            <thead>
                <tr>
                    <th>상품 ID</th>
                    <th>상품명</th>
                    <th>가격</th>
                    <th>할인 금액</th>
                    <th>재고</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>${data.itemId}</td>
                    <td>${data.name}</td>
                    <td>${data.price.toLocaleString()}원</td>
                    <td>${data.discountPrice.toLocaleString()}원</td>
                    <td>${data.stock}</td>
                </tr>
            </tbody>
        </table>`;

        html += `<p>환불 금액: <strong>${data.canceledPrice.toLocaleString()}원</strong></p>`;
        html += `<p>취소 후 남은 주문 총 금액: <strong>${data.totalPrice.toLocaleString()}원</strong></p>`;

        container.innerHTML = html;
    }

    // 주문 조회 결과 렌더링 (GetOrderResponse DTO 기반)
    function renderGetOrderResult(data, error) {
        const container = document.getElementById('getOrderResult');
        container.innerHTML = '';

        if (error) {
            container.innerHTML = `<p class="error">❌ ${error}</p>`;
            return;
        }

        let html = `<p>주문번호: <strong>${data.orderId}</strong></p>`;
        html += `<p>총 주문 금액: <strong>${data.totalPrice.toLocaleString()}원</strong></p>`;

        if (data.orderItemList && data.orderItemList.length > 0) {
            html += `<table>
                <thead>
                    <tr>
                        <th>상품 ID</th>
                        <th>상품명</th>
                        <th>판매가격</th>
                        <th>할인금액</th>
                        <th>수량</th>
                        <th>실구매금액</th>
                        <th>주문 상태</th>
                    </tr>
                </thead>
                <tbody>`;
            data.orderItemList.forEach(item => {
                html += `<tr>
                    <td>${item.itemId}</td>
                    <td>${item.name}</td>
                    <td>${item.price.toLocaleString()}원</td>
                    <td>${item.discountPrice.toLocaleString()}원</td>
                    <td>${item.quantity}</td>
                    <td>${item.purchasePrice.toLocaleString()}원</td>
                    <td>${item.orderStatus}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
        } else {
            html += `<p>주문 상품이 없습니다.</p>`;
        }

        container.innerHTML = html;
    }

    // 에러 핸들링 포함 fetch 함수
    async function fetchJsonWithErrorHandling(url, options) {
        try {
            const res = await fetch(url, options);
            if (!res.ok) {
                let errJson;
                try {
                    errJson = await res.json();
                    throw new Error(errJson.message || '알 수 없는 오류가 발생했습니다.');
                } catch {
                    throw new Error('서버 오류가 발생했습니다.');
                }
            }
            return await res.json();
        } catch (err) {
            return { error: err.message };
        }
    }

    // 주문 생성 이벤트
    document.getElementById('createOrderForm').addEventListener('submit', async e => {
        e.preventDefault();
        const itemRows = document.querySelectorAll('#itemList .item-row');
        const orderItemList = [];

        itemRows.forEach(row => {
            const itemId = row.querySelector('[name="itemId"]').value;
            const quantity = row.querySelector('[name="quantity"]').value;
            if (itemId && quantity) {
                orderItemList.push({ itemId: parseInt(itemId), quantity: parseInt(quantity) });
            }
        });

        const data = { orderItemList };
        const result = await fetchJsonWithErrorHandling('/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (result.error) {
            renderCreateOrderResult(null, result.error);
        } else {
            renderCreateOrderResult(result);
        }
    });

    // 주문 상품 취소 이벤트
    document.getElementById('cancelOrderForm').addEventListener('submit', async e => {
        e.preventDefault();
        const form = e.target;
        const orderId = form.orderId.value;
        const itemId = form.itemId.value;

        const data = {
            orderId: parseInt(orderId),
            itemId: parseInt(itemId)
        };

        const result = await fetchJsonWithErrorHandling(`/orders/${orderId}/cancel/${itemId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (result.error) {
            renderCancelOrderResult(null, result.error);
        } else {
            renderCancelOrderResult(result);
        }
    });

    // 주문 조회 이벤트
    document.getElementById('getOrderForm').addEventListener('submit', async e => {
        e.preventDefault();
        const orderId = e.target.orderId.value;

        const result = await fetchJsonWithErrorHandling(`/orders/${orderId}`);

        if (result.error) {
            renderGetOrderResult(null, result.error);
        } else {
            renderGetOrderResult(result);
        }
    });
</script>
</body>
</html>
