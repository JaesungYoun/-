<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>ì£¼ë¬¸ API í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1, h2 { color: #333; }
        section { margin-bottom: 40px; }
        label { display: inline-block; width: 80px; }
        input[type=number] { width: 150px; padding: 5px; margin-right: 10px; }
        button { padding: 6px 12px; cursor: pointer; }
        table { border-collapse: collapse; margin-top: 10px; width: 100%; max-width: 700px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #f8f8f8; }
        .error { color: #c00; font-weight: bold; margin-top: 10px; }
        .success { color: #080; font-weight: bold; margin-top: 10px; }
        .item-row { margin-bottom: 5px; }
    </style>
</head>
<body>
<h1>ğŸ›’ ì£¼ë¬¸ API í…ŒìŠ¤íŠ¸ í™”ë©´</h1>

<!-- ì£¼ë¬¸ ìƒì„± -->
<section>
    <h2>1. ì£¼ë¬¸ ìƒì„± (ì—¬ëŸ¬ ìƒí’ˆ)</h2>
    <form id="createOrderForm">
        <div id="itemList">
            <div class="item-row">
                <label>ìƒí’ˆ ID:</label>
                <input type="number" name="itemId" required />
                <label>ìˆ˜ëŸ‰:</label>
                <input type="number" name="quantity" value="1" min="1" required />
                <button type="button" onclick="removeItemRow(this)">âŒ</button>
            </div>
        </div>
        <button type="button" onclick="addItemRow()">â• ìƒí’ˆ ì¶”ê°€</button><br /><br />
        <button type="submit">ì£¼ë¬¸ ìƒì„±</button>
    </form>
    <div id="createOrderResult"></div>
</section>

<!-- ì£¼ë¬¸ ìƒí’ˆ ì·¨ì†Œ -->
<section>
    <h2>2. ì£¼ë¬¸ ìƒí’ˆ ì·¨ì†Œ</h2>
    <form id="cancelOrderForm">
        <label>ì£¼ë¬¸ ID:</label>
        <input type="number" name="orderId" required />
        <label>ìƒí’ˆ ID:</label>
        <input type="number" name="itemId" required />
        <button type="submit">ìƒí’ˆ ì·¨ì†Œ</button>
    </form>
    <div id="cancelOrderResult"></div>
</section>

<!-- ì£¼ë¬¸ ì¡°íšŒ -->
<section>
    <h2>3. ì£¼ë¬¸ ì¡°íšŒ</h2>
    <form id="getOrderForm">
        <label>ì£¼ë¬¸ ID:</label>
        <input type="number" name="orderId" required />
        <button type="submit">ì£¼ë¬¸ ì¡°íšŒ</button>
    </form>
    <div id="getOrderResult"></div>
</section>

<script>
    function addItemRow() {
        const itemList = document.getElementById('itemList');
        const row = document.createElement('div');
        row.className = 'item-row';
        row.innerHTML = `
            <label>ìƒí’ˆ ID:</label>
            <input type="number" name="itemId" required />
            <label>ìˆ˜ëŸ‰:</label>
            <input type="number" name="quantity" value="1" min="1" required />
            <button type="button" onclick="removeItemRow(this)">âŒ</button>
        `;
        itemList.appendChild(row);
    }

    function removeItemRow(button) {
        button.parentNode.remove();
    }

    // ì£¼ë¬¸ ìƒì„± ê²°ê³¼ ë Œë”ë§ (CreateOrderResponse DTO ê¸°ë°˜)
    function renderCreateOrderResult(data, error) {
        const container = document.getElementById('createOrderResult');
        container.innerHTML = '';

        if (error) {
            container.innerHTML = `<p class="error">âŒ ${error}</p>`;
            return;
        }

        // ì„±ê³µ ì‹œ orderId, totalPrice, orderItemList ì¶œë ¥
        let html = `<p class="success">âœ… ì£¼ë¬¸ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì£¼ë¬¸ë²ˆí˜¸: <strong>${data.orderId}</strong></p>`;
        html += `<p>ì´ ì£¼ë¬¸ ê¸ˆì•¡: <strong>${data.totalPrice.toLocaleString()}ì›</strong></p>`;

        if (data.orderItemList && data.orderItemList.length > 0) {
            html += `<table>
                <thead>
                    <tr>
                        <th>ìƒí’ˆ ID</th>
                        <th>ìƒí’ˆëª…</th>
                        <th>ìˆ˜ëŸ‰</th>
                        <th>ì‹¤êµ¬ë§¤ê¸ˆì•¡</th>
                    </tr>
                </thead>
                <tbody>`;
            data.orderItemList.forEach(item => {
                const total = item.purchasePrice * item.quantity;
                html += `<tr>
                    <td>${item.itemId}</td>
                    <td>${item.name || '-'}</td>
                    <td>${item.quantity}</td>
                    <td>${item.purchasePrice.toLocaleString()}ì›</td>
                </tr>`;
            });
            html += `</tbody></table>`;
        }
        container.innerHTML = html;
    }

    // ì£¼ë¬¸ ìƒí’ˆ ì·¨ì†Œ ê²°ê³¼ ë Œë”ë§ (CancelOrderItemResponse DTO ê¸°ë°˜)
    function renderCancelOrderResult(data, error) {
        const container = document.getElementById('cancelOrderResult');
        container.innerHTML = '';

        if (error) {
            container.innerHTML = `<p class="error">âŒ ${error}</p>`;
            return;
        }

        let html = `<p class="success">âœ… ìƒí’ˆì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>`;
        html += `<table>
            <thead>
                <tr>
                    <th>ìƒí’ˆ ID</th>
                    <th>ìƒí’ˆëª…</th>
                    <th>ê°€ê²©</th>
                    <th>í• ì¸ ê¸ˆì•¡</th>
                    <th>ì¬ê³ </th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>${data.itemId}</td>
                    <td>${data.name}</td>
                    <td>${data.price.toLocaleString()}ì›</td>
                    <td>${data.discountPrice.toLocaleString()}ì›</td>
                    <td>${data.stock}</td>
                </tr>
            </tbody>
        </table>`;

        html += `<p>í™˜ë¶ˆ ê¸ˆì•¡: <strong>${data.canceledPrice.toLocaleString()}ì›</strong></p>`;
        html += `<p>ì·¨ì†Œ í›„ ë‚¨ì€ ì£¼ë¬¸ ì´ ê¸ˆì•¡: <strong>${data.totalPrice.toLocaleString()}ì›</strong></p>`;

        container.innerHTML = html;
    }

    // ì£¼ë¬¸ ì¡°íšŒ ê²°ê³¼ ë Œë”ë§ (GetOrderResponse DTO ê¸°ë°˜)
    function renderGetOrderResult(data, error) {
        const container = document.getElementById('getOrderResult');
        container.innerHTML = '';

        if (error) {
            container.innerHTML = `<p class="error">âŒ ${error}</p>`;
            return;
        }

        let html = `<p>ì£¼ë¬¸ë²ˆí˜¸: <strong>${data.orderId}</strong></p>`;
        html += `<p>ì´ ì£¼ë¬¸ ê¸ˆì•¡: <strong>${data.totalPrice.toLocaleString()}ì›</strong></p>`;

        if (data.orderItemList && data.orderItemList.length > 0) {
            html += `<table>
                <thead>
                    <tr>
                        <th>ìƒí’ˆ ID</th>
                        <th>ìƒí’ˆëª…</th>
                        <th>íŒë§¤ê°€ê²©</th>
                        <th>í• ì¸ê¸ˆì•¡</th>
                        <th>ìˆ˜ëŸ‰</th>
                        <th>ì‹¤êµ¬ë§¤ê¸ˆì•¡</th>
                        <th>ì£¼ë¬¸ ìƒíƒœ</th>
                    </tr>
                </thead>
                <tbody>`;
            data.orderItemList.forEach(item => {
                html += `<tr>
                    <td>${item.itemId}</td>
                    <td>${item.name}</td>
                    <td>${item.price.toLocaleString()}ì›</td>
                    <td>${item.discountPrice.toLocaleString()}ì›</td>
                    <td>${item.quantity}</td>
                    <td>${item.purchasePrice.toLocaleString()}ì›</td>
                    <td>${item.orderStatus}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
        } else {
            html += `<p>ì£¼ë¬¸ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
        }

        container.innerHTML = html;
    }

    // ì—ëŸ¬ í•¸ë“¤ë§ í¬í•¨ fetch í•¨ìˆ˜
    async function fetchJsonWithErrorHandling(url, options) {
        try {
            const res = await fetch(url, options);
            if (!res.ok) {
                let errJson;
                try {
                    errJson = await res.json();
                    throw new Error(errJson.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                } catch {
                    throw new Error('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
            return await res.json();
        } catch (err) {
            return { error: err.message };
        }
    }

    // ì£¼ë¬¸ ìƒì„± ì´ë²¤íŠ¸
    document.getElementById('createOrderForm').addEventListener('submit', async e => {
        e.preventDefault();
        const itemRows = document.querySelectorAll('#itemList .item-row');
        const orderItemList = [];

        itemRows.forEach(row => {
            const itemId = row.querySelector('[name="itemId"]').value;
            const quantity = row.querySelector('[name="quantity"]').value;
            if (itemId && quantity) {
                orderItemList.push({ itemId: parseInt(itemId), quantity: parseInt(quantity) });
            }
        });

        const data = { orderItemList };
        const result = await fetchJsonWithErrorHandling('/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (result.error) {
            renderCreateOrderResult(null, result.error);
        } else {
            renderCreateOrderResult(result);
        }
    });

    // ì£¼ë¬¸ ìƒí’ˆ ì·¨ì†Œ ì´ë²¤íŠ¸
    document.getElementById('cancelOrderForm').addEventListener('submit', async e => {
        e.preventDefault();
        const form = e.target;
        const orderId = form.orderId.value;
        const itemId = form.itemId.value;

        const data = {
            orderId: parseInt(orderId),
            itemId: parseInt(itemId)
        };

        const result = await fetchJsonWithErrorHandling(`/orders/${orderId}/cancel/${itemId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (result.error) {
            renderCancelOrderResult(null, result.error);
        } else {
            renderCancelOrderResult(result);
        }
    });

    // ì£¼ë¬¸ ì¡°íšŒ ì´ë²¤íŠ¸
    document.getElementById('getOrderForm').addEventListener('submit', async e => {
        e.preventDefault();
        const orderId = e.target.orderId.value;

        const result = await fetchJsonWithErrorHandling(`/orders/${orderId}`);

        if (result.error) {
            renderGetOrderResult(null, result.error);
        } else {
            renderGetOrderResult(result);
        }
    });
</script>
</body>
</html>
